(function($) {
    "use strict";
    $.fn.counterUp = function(options) {
        var settings = $.extend({
            time: 400,
            delay: 10
        }, options);

        return this.each(function() {
            var $this = $(this);
            
            // 실행 함수 정의
            var runCounter = function() {
                var isComma = /[0-9]+,[0-9]+/.test($this.text());
                var num = $this.text().replace(/,/g, "");
                var isFloat = /^[0-9]+\.[0-9]+$/.test(num);
                var decimalPlaces = isFloat ? (num.split(".")[1] || []).length : 0;
                var divisions = settings.time / settings.delay;
                var nums = [];

                for (var i = divisions; i >= 1; i--) {
                    var newNum = (num / divisions * i);
                    if (isFloat) {
                        newNum = parseFloat(newNum).toFixed(decimalPlaces);
                    } else {
                        newNum = parseInt(newNum);
                    }
                    if (isComma) {
                        while (/(\d+)(\d{3})/.test(newNum.toString())) {
                            newNum = newNum.toString().replace(/(\d+)(\d{3})/, '$1,$2');
                        }
                    }
                    nums.unshift(newNum);
                }

                $this.data('counterup-nums', nums);
                $this.text('0');

                var f = function() {
                    var currentNum = $this.data('counterup-nums').shift();
                    $this.text(currentNum);
                    if ($this.data('counterup-nums').length) {
                        setTimeout(f, settings.delay);
                    }
                };
                f();
            };

            // [Intersection Observer] 스크롤 감지 로직
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) { // 화면에 보이면
                        runCounter();         // 카운터 실행
                        observer.unobserve(entry.target); // 한 번만 실행 후 감지 종료
                    }
                });
            }, { threshold: 0.5 }); // 요소가 50% 이상 보일 때 시작

            observer.observe(this);
        });
    };
})(jQuery);